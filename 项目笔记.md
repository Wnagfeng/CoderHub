### é¡¹ç›®ç¬”è®°

### åˆ›å»ºä¸€ä¸ªç”¨æˆ·è¡¨

```mysql
CREATE TABLE IF NOT EXISTS `user`(
	id INT PRIMARY KEY AUTO_INCREMENT,
	name VARCHAR(30) NOT NULL UNIQUE,
	password VARCHAR(50) NOT NULL,
	createAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	updateAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

Cookie é¥¼å¹² å‰ç«¯ä¸€èˆ¬å¾ˆå°‘ä½¿ç”¨ åç«¯æ¯”è¾ƒå¤šæœ‰äº›ç½‘ç«™ä¸ºäº†è¾¨åˆ«ç”¨æˆ·èº«ä»½ä¼šåœ¨ç”¨æˆ·æœ¬åœ°å®¢æˆ·ç«¯ ä¸Šå­˜å‚¨çš„æ•°æ®ğŸ“•

æµè§ˆå™¨ä¼šåœ¨ç‰¹å®šçš„æƒ…å†µä¸‹æºå¸¦ç‰¹å®šçš„cookieæ¥å‘è¯·æ±‚ åç«¯å¯ä»¥é€šè¿‡cookieæ¥è·å–ä¿¡æ¯

å¦‚æœä½ æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´ åœ¨å…³é—­æµè§ˆå™¨æ—¶å€™ä¼šè‡ªåŠ¨åˆ é™¤

å¦‚æœä½ è®¾ç½®æ—¶é—´åˆ™ä¼šåœ¨è¿‡æœŸæ—¶é—´ååˆ é™¤



### ç™»å½•çš„é€»è¾‘(æ³¨æ„jwtçš„ç‰ˆæœ¬ å¤§å‘ä¸€ä¸ªè¯¯è·³)

æˆ‘ä»¬ä¹‹å‰åšåå°çš„æ—¶å€™éƒ½çŸ¥é“ä¼šæœ‰ä¸€ä¸ªtoken è¿™ä¸ªtokenä¹Ÿæ˜¯æˆ‘ä»¬è¿›è¡Œèº«ä»½éªŒè¯çš„å…³é”®

è€ƒè™‘åˆ°å®‰å…¨æ€§æˆ‘ä»¬è¿™é‡Œä½¿ç”¨éå¯¹ç§°åŠ å¯†æ–¹æ¡ˆ å³ä½¿ç”¨ä¸€ä¸ªç§æœ‰ç§˜é’¥ç”Ÿæˆtoken é€šè¿‡å…¬å…±ç§˜é’¥è¿›è¡Œè§£å¯†token

```
å½“ç”¨æˆ·é¦–æ¬¡ç™»å½•æˆåŠŸä¹‹å, æœåŠ¡å™¨ç«¯å°±ä¼šç”Ÿæˆä¸€ä¸ª token å€¼ï¼Œè¿™ä¸ªå€¼ï¼Œä¼šåœ¨æœåŠ¡å™¨ä¿å­˜tokenå€¼(ä¿å­˜åœ¨æ•°æ®åº“ä¸­)ï¼Œå†å°†è¿™ä¸ªtokenå€¼è¿”å›ç»™å®¢æˆ·ç«¯ï¼›

æœåŠ¡å™¨ç«¯æœ‰ä¸€ä¸ªä¸“é—¨çš„ä¿å­˜ç”¨æˆ·ç™»å½•çš„è¡¨ï¼Œå…¶ä¸­æœ‰ token å­—æ®µï¼Œç”¨æˆ·æ¯æ¬¡ç™»å½•éƒ½ä¼šæ›´æ–°è¡¨ä¸­tokenå­—æ®µï¼›

å®¢æˆ·ç«¯æ‹¿åˆ° token å€¼ä¹‹åï¼Œè¿›è¡Œä¿å­˜ ï¼ˆä¿å­˜ä½ç½®ç”±æœåŠ¡å™¨ç«¯è®¾ç½®ï¼‰ï¼›

ä»¥åå®¢æˆ·ç«¯å†æ¬¡å‘é€ç½‘ç»œè¯·æ±‚(ä¸€èˆ¬ä¸æ˜¯ç™»å½•è¯·æ±‚)çš„æ—¶å€™,å°±ä¼šå°†è¿™ä¸ª token å€¼é™„å¸¦åˆ°å‚æ•°ä¸­å‘é€ç»™æœåŠ¡å™¨.ï¼›

æœåŠ¡å™¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚ä¹‹å,ä¼šå–å‡ºtokenå€¼ä¸ä¿å­˜åœ¨æœ¬åœ°(æ•°æ®åº“)ä¸­çš„tokenå€¼è¿›è¡Œæ¯”è¾ƒï¼›

å¦‚æœä¸¤ä¸ª token å€¼ç›¸åŒï¼Œ è¯´æ˜ç”¨æˆ·ç™»å½•æˆåŠŸè¿‡!å½“å‰ç”¨æˆ·å¤„äºç™»å½•çŠ¶æ€ï¼›

å¦‚æœæ²¡æœ‰è¿™ä¸ª token å€¼, æ²¡æœ‰ç™»å½•æˆåŠŸï¼›

å¦‚æœ token å€¼ä¸åŒ: è¯´æ˜åŸæ¥çš„ç™»å½•ä¿¡æ¯å·²ç»å¤±æ•ˆ,è®©ç”¨æˆ·é‡æ–°ç™»å½•ï¼›

Django Rest frameworkä¸­JWTçš„ä½¿ç”¨ç¨æœ‰å·®å¼‚ï¼Œè¿™é‡Œä¸åšè¯¦ç»†è¯´æ˜ã€‚

 
```



å½“æˆ‘ä»¬è¿™è¾¹çš„ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åæˆ‘ä»¬ç»™ä»–é¢å‘ä¸€ä¸ªtoken ç„¶åæˆ‘ä»¬å¯¹å…¶è¿›è¡ŒéªŒè¯ 

æ­¥éª¤é¦–å…ˆå®‰è£…jsonwebtokenè¿™ä¸ªåº“

npm i jsonwebtoken

æˆ‘ä»¬åœ¨é¡¹ç›®ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªkeysç›®å½•ç”¨æ¥ä¿å­˜æˆ‘ä»¬çš„key

é‡Œé¢çš„keyæœ‰å…¬é’¥ å’Œç§é’¥

æˆ‘ä»¬é€šè¿‡ç§é’¥æ¥ç”Ÿæˆtoken é€šè¿‡å…¬é’¥æ¥è§£ç token 

é€šè¿‡git bush heareæ¥æ‰“å¼€ä½ çš„keyç›®å½• æ‰§è¡Œåˆ›å»ºç§é’¥å‘½ä»¤

![image-20230718152202624](C:\Users\WangFeng\AppData\Roaming\Typora\typora-user-images\image-20230718152202624.png)

 æ‰§è¡Œåˆ›å»ºå…¬é’¥å‘½ä»¤

rsa -in private.key -pubout -out public.key

![image-20230718152623821](C:\Users\WangFeng\AppData\Roaming\Typora\typora-user-images\image-20230718152623821.png)

```js
//ç”Ÿæˆtokençš„ä»£ç 
const token = jsonwebtoken.sign({ id, name }, privateKey, {

   expiresIn: 24 * 60 * 60,

   algorithm:"RS256"

  });
privateKey---è‡ªå·±ç”¨fsè¯»å–
```

```js
//è§£å¯†tokençš„ä»£ç 
const jwt = require('jsonwebtoken');
const { PUBLIC_KEY } = require('../config/screct');
const { UNAUTHOURIZATHION } = require('../config/error-constance');
const LoginVerify = (ctx, next) => {
  const authorization = ctx.headers.authorization;
  const token = authorization.replace('Bearer ', '');
  // æ‹¿åˆ°tokenä»¥åæˆ‘ä»¬éœ€è¦è¿›è¡Œæ¯”å¯¹ å¦‚æœéªŒè¯é€šè¿‡å°±å¯ä»¥ç»§ç»­æ‰§è¡Œè·å–è¯·æ±‚
  try {
    const res = jwt.verify(token, PUBLIC_KEY, {
      algorithms: ['RS256'],
    });
    console.log(res);
    
    ctx.body = 'å¯ä»¥è®¿é—®loginä¸‹çš„æ¥å£äº†';
  } catch (error) {
    ctx.app.emit('error', UNAUTHOURIZATHION, ctx);
  }
};
module.exports = LoginVerify;
```

### è‡ªåŠ¨åŒ–ç¨‹åº

æˆ‘ä»¬éœ€è¦å®ç°è‡ªåŠ¨åŒ–æ³¨å†Œè·¯ç”±

å½“æˆ‘ä»¬åœ¨routeræ–‡ä»¶å¤¹ä¸‹å†™å¥½ä¸€ä¸ªè·¯ç”±ä»¥ååœ¨appä¸­ä½ ç»™æˆ‘è‡ªåŠ¨å¯¼å…¥

```js
// è¿™é‡Œæ˜¯è‡ªåŠ¨åŒ–ç¨‹åº
const fs = require('fs');
function registerRouters(app) {
  const files = fs.readdirSync(__dirname);
  // åªè¦æ˜¯ä»¥.router.jsç»“å°¾çš„æ–‡ä»¶éƒ½è¦
  for (const file of files) {
    if (!file.endsWith('.router.js')) continue;
    const router = require(`./${file}`);
      //åªè¦app.useä½¿ç”¨äº†å°±è¡Œä¸ç”¨ç®¡ä»–åœ¨é‚£é‡Œç”¨çš„
    app.use(router.routes());
    app.use(router.allowedMethods());
  }
}
module.exports = registerRouters;

```

